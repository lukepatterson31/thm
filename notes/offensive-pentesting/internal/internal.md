# Internal

### Pre-engagemnt Briefing

You have been assigned to a client that wants a penetration test conducted on an environment 
due to be released to production in three weeks. 

Scope of Work

The client requests that an engineer conducts an external, web app, and internal assessment 
of the provided virtual environment. The client has asked that minimal information be 
provided about the assessment, wanting the engagement conducted from the eyes of a malicious 
actor (black box penetration test).  The client has asked that you secure two flags (no 
location provided) as proof of exploitation:

- User.txt
- Root.txt

Additionally, the client has provided the following scope allowances:

- Ensure that you modify your hosts file to reflect internal.thm
- Any tools or techniques are permitted in this engagement
- Locate and note all vulnerabilities found
- Submit the flags discovered to the dashboard
- Only the IP address assigned to your machine is in scope

### Reconnaissance

[nmap port scan](./internal-full-port.nmap)

[nmap scan](./internal.nmap)

[gobuster dns scan](./internal-dns.gobuster)

[gobuster dir scan](./internal-dir.gobuster)

[Nikto scan](./internal.nikto)

[WPScan scan](./internal.wpscan)



OpenSSH 7.6p1 potential exploit CVE 2018-15473 ExploitDB-ID 45233

Apache server 2.4.29 running on Ubuntu 4.03 [multiple CVE's](https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=&cad=rja&uact=8&ved=2ahUKEwj91daN2uz9AhUVilwKHYV5BVoQFnoECAkQAQ&url=https%3A%2F%2Fwww.cvedetails.com%2Fvulnerability-list%2Fvendor_id-45%2Fproduct_id-66%2Fversion_id-576122%2FApache-Http-Server-2.4.29.html&usg=AOvVaw0tMnIUamPfYDbhiyJx4_RY) 

Wordpress version 5.4.2

**/blog**

Wordpress site

**/javascript**

forbidden

**/phpmyadmin**

phpMyAdmin CMS page

**/wordpress**

Leads to "page can't be found" wordpress page with search bar, SQLi/XSS/PHP 
injection? 

internal.thm/wordpress/wp-admin

internal.thm/wordpress/wp-content

internal.thm/wordpress/wp-content/plugins/

internal.thm/wordpress/wp-content/themes/

internal.thm/wordpress/wp-includes

internal.thm/wordpress/xmlrpc.php


Empty search on /wordpress leads to a sample page link (http://internal.thm/blog/index.php/
sample-page) which leads to wp-admin link (http://192.168.1.45/blog/wp-admin/). Replacing 
the local address with internal.thm leads us to the wordpress login page.

The lost password action allows us to enumerate usernames/emails:

- admin

**hydra**

`hydra -l admin -P /usr/share/wordlists/rockyou.txt internal.thm http-post-form "/blog/wp-login.php:wp-submit=Log+In&redirect_to=http%3A%2F%2Finternal.thm%2Fblog%2Fwp-admin%2F&testcookie=1&log=^USER^&pwd=^PASS^:Error"`

found admin password with hydra

### Exploitation

Using the credentials found with hydra, log in to the Wordpress dashboard and edit the 
twentyseventeen theme by replacing the contents of header.php with a php reverse shell,
which will execute when navigating to the home page, to gain a foothold on the target.

Running [linpeas](./internal.peas) shows that the target is vulnerable to CVE 2021-4034.

`searchsploit --cve 2021-4034`

The target doesn't have the necessary dependencies installed to compile so the binary needs 
to be compiled on the attacker's machine and be made static.

`gcc exploit.c -static -o exploit`

*Note: Not great practice to static compile on a different machine, can cause difficult to 
debug issues*

Upload the exploit and evil.so to the target, use chmod to give executable permissions and 
run the exploit to gain root.

The root flag is located in /root and the user flag in a user's /home directory. 

*Note: The CVE I used to exploit this machine wasn't discovered when this was created and 
circumvents a lot of the lessons showcased*

**Official write-up** - [article](https://medium.themayor.tech/internal-walk-through-on-tryhackme-49f3c3b30352)

Credentials for user in /opt

*Note: Make a script to find credentials in unconventional places. Look for credentials, 
two words split by : i.e: username:password, text files etc.*

Jenkins server details in txt file, ssh tunnel to it with credentials from opt

`ssh -L 8080:<JENKINS-IP>:8080 <USERNAME>@<TARGET-IP>`

Brute force Jenkins credentials with admin username

Use Jenkins to execute a remote shell gaining access to the Jenkins machine

Manual enumeration to find credentials in /opt

