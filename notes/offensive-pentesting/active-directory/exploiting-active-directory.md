# Exploiting Active Directory

### AD Exploitation

The exploitation phase exploits misconfigurations to perform a combination of lateral movement and privilege 
escalation until we reach a suitable position to execute our goals, as shown in the diagram below. This 
phase is usually combined with persistence, to ensure that we can't lose the new position we gain, and 
additional enumeration since our new position might allow us to acquire additional information about the lay 
of the land.

![Cyber kill chain](../pictures/kill-chain.png)

**Learning Objectives:**

- AD Delegation
- Forcing Authentication Relays
- Group Policy Objects
- Targeting AD Users
- Domain Trusts
- Silver and Golden Tickets

### Eploiting Permission Delegation

Active Directory can delegate permissions and privileges through a feature called Permission Delegation.
Delegation is what makes AD so powerful in organisations. Imagine we work for an organisation that has 50000 
employees. Since we care about security, we only have three users that have access to DA credentials. It 
would be impossible for those three users to field all requests from the users, such as resetting their 
passwords. Using Delegation, we can delegate the permission to force change a user's password to the 
Helpdesk team, meaning they now have a delegated privilege for this specific function. In principle, to keep 
Delegation secure, the principle of least privilege should be followed.

**Permission Delegation**

Permission Delegation attacks a.k.a ACL-based attacks

AD allows administrators to configure Access Control Entries (ACEs) that populates Discretionary Access 
Control Lists (DACLs), hence the name ACL-based attacks. Almost any AD object can be secured with ACEs, 
which then describe the allowed and denied permissions that any other AD object has against the target 
object.

However, if these ACEs are misconfigured, it may be possible for an attacker to exploit them. Let's look at 
our example again. If the IT Support team were granted the ForceChangePassword ACE over the Domain Users 
group, this would be considered insecure. Sure they would be able to reset the passwords of employees that 
forgot their passwords, but this misconfiguration would allow them to also reset the passwords of privileged 
accounts, such as the accounts that are members of the Domain Admins group essentially allowing for 
privilege escalation.

**Exploiting ACEs**

A significant amount of ACEs can be misconfigured, and the exploits for each vary. The [Bloodhound docs](https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#) assist in explaining enumerated ACEs and how they can be exploited.

Notable ACEs:

- ForceChangePassword: We have the ability to set the user's current password without knowing their current 
password.

- AddMembers: We have the ability to add users (including our own account), groups or computers to the 
target group.

- GenericAll: We have complete control over the object, including the ability to change the user's password, 
register an SPN or add an AD object to the target group.

- GenericWrite: We can update any non-protected parameters of our target object. This could allow us to, for 
example, update the scriptPath parameter, which would cause a script to execute the next time the user logs 
on.

- WriteOwner: We have the ability to update the owner of the target object. We could make ourselves the 
owner, allowing us to gain additional permissions over the object.

- WriteDACL: We have the ability to write new ACEs to the target object's DACL. We could, for example, write 
an ACE that grants our account full control over the target object.

- AllExtendedRights: We have the ability to perform any action associated with extended AD rights against 
the target object. This includes, for example, the ability to force change a user's password.

In order to exploit these ACEs, we will need a method to interact with AD to make these requests. The two 
best options for this are: 

- AD-RSAT PowerShell cmdlets
- PowerSploit. 

Depending on the breach and the detection tools in the environment, one option may be stealthier.

**Bloodhound**

Execute SharpHound (same version as BloodHound installation!) on a windows machine connected to the domain

`SharpHound.exe --CollectionMethods All --Domain <DOMAIN> --ExcludeDCs`

Use scp to copy the zip file to our atacking machine:

`scp <USERNAME>@<WINDOWS-MACHINE>:C:/path/to/zip/file .`

Start Neo4j and BloodHound;

```
neo4j console

bloodhound --no-sandbox
```

Authenticate with Neo4j credentials.

**Privilege Escalation**

- Search for privileges associated with the user account
- Search for administrative privileges on all workstations
- View roads in bloodhound leading to accounts for privilege escalation
- Look for permission delegation misconfiguration leading to attack paths

A road from our Domain user to the T2 admins shows that a GenericWrite privilege for IT Support is delegated 
to domain which in turn allows IT Support group members ForceChangePassword of T" admins

Exploit the GenericWrite privilege delegation misconfiguration by adding your domain user to IT Support:

THMWRK1
```
powershell
Add-ADGroupMember "IT Support" -Members
```

**ForceChangePassword**

Find an account to takeover:

`Get-ADGroupMember -Identity "Tier 2 Admins"`

Set a new password:

```
$Password = ConvertTo-SecureString "NewPassword" -AsPlainText -Force
Set-ADAccountPassword -Identity "UsernameOfTarget" -Reset -NewPassword $Password
```

Note: Permissions can take a few minutes to propagate through the domain.

### Exploiting Kerberos Delegation

**Kerberos Delegation**

Kerberos Delegation enables an application to access resources hosted on a different server. An example of 
this would be a web server that needs to access a SQL database hosted on the database server for the web 
application that it is hosting. Without delegation, we would probably use an AD service account and provide 
it with direct access to the database. When requests are made on the web application, the service account 
would be used to authenticate to the database and recover information.

However, we can allow this service account to be delegated to the SQL server service. Once a user logs into 
our web application, the service account will request access to the database on behalf of that user. This 
means that the user would only be able to access data in the database that they have the relevant 
permissions for without having to provide any database privileges or permissions to the service account 
itself.

**Constrained vs Unconstrained**
