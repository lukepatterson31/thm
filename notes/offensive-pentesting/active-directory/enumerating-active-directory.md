# Enumerating Active Directory

### Why AD Enumeration

**AD Enumeration**

Once we have that first set of AD credentials and the means to authenticate with them on the network, 
we can start enumerating various details about the AD setup and structure with authenticated access, 
even super low-privileged access.

During a red team engagement, this will usually lead to us being able to perform some form of 
privilege escalation or lateral movement to gain additional access until we have sufficient privileges 
to execute and reach our goals. 

In most cases, enumeration and exploitation are heavily entwined. Once an attack path shown by the 
enumeration phase has been exploited, enumeration is again performed from this new privileged position.

![Kill Chain](../pictures/kill-chain.png)


**Learning Objectives**

Enumeration techniques are usually highly situational and dependant on the acquired breach. We will 
cover the following techniques:

- The AD snap-ins of the Microsoft Management Console

- The net commands of Command Prompt

- The AD-RSAT cmdlets of PowerShell

- Bloodhound


### Credential Injection

**Runas Explained**

In security assessments, you will often have network access and have just discovered AD credentials 
but have no means or privileges to create a new domain-joined machine. So we need the ability to use 
those credentials on a Windows machine we control.

If we have the AD credentials in the format of :, we can use Runas, a legitimate Windows binary, to 
inject the credentials into memory. 

`runas.exe /netonly /user:<DOMAIN>\<USERNAME> cmd.exe`

- /netonly - Since we are not domain-joined, we want to load the credentials for network 
authentication but not authenticate against a domain controller. So commands executed locally on the 
computer will run in the context of your standard Windows account, but any network connections will 
occur using the account specified here.

- /user - Here, we provide the details of the domain and the username. It is always a safe bet to use 
the Fully Qualified Domain Name (FQDN) instead of just the NetBIOS name of the domain since this will 
help with resolution.

- cmd.exe - This is the program we want to execute once the credentials are injected. This can be 
changed to anything, but the safest bet is cmd.exe since you can then use that to launch whatever you 
want, with the credentials injected.

Once you run this command, you will be prompted to supply a password. Note that since we added the 
/netonly parameter, the credentials will not be verified directly by a domain controller so that it 
will accept any password. We still need to confirm that the network credentials are loaded 
successfully and correctly.


**It's Always DNS**

After providing the password, a new command prompt window will open. Now we still need to verify that 
our credentials are working. The most surefire way to do this is to list SYSVOL. Any AD account, no 
matter how low-privileged, can read the contents of the SYSVOL directory.

SYSVOL is a folder that exists on all domain controllers. It is a shared folder storing the Group 
Policy Objects (GPOs) and information along with any other domain related scripts. It is an essential 
component for Active Directory since it delivers these GPOs to all computers on the domain. 
Domain-joined computers can then read these GPOs and apply the applicable ones, making domain-wide 
configuration changes from a central location.

Before we can list SYSVOL, we need to configure our DNS. Sometimes you are lucky, and internal DNS 
will be configured for you automatically through DHCP or the VPN connection, but not always (like this 
TryHackMe network). It is good to understand how to do it manually. Your safest bet for a DNS server 
is usually a domain controller. Using the IP of the domain controller, we can execute the following 
commands in a PowerShell window:

```
$dnsip = "<DC IP>"
$index = Get-NetAdapter -Name '<ADAPTER-NAME>' | Select-Object -ExpandProperty 'ifIndex'
Set-DnsClientServerAddress -InterfaceIndex $index -ServerAddresses $dnsip
```

Then use dir to force a network-based listing of SYSVOL

`dir \\za.tryhackme.com\SYSVOL\`

It is good to enumerate SYSVOL as there may be additional AD credentials there.


**IP vs Hostnames**

Depending on whether the IP or hostname is used the authentication method changes. Hostnames will 
authenticate with kerberos and IP's with NTLM.

While on the surface, this does not matter to us right now, it is good to understand these slight 
differences since they can allow you to remain more stealthy during a Red team assessment. In some 
instances, organisations will be monitoring for OverPass- and Pass-The-Hash Attacks. Forcing NTLM 
authentication is a good trick to have in the book to avoid detection in these cases.


**Using Injected Credentials**

Now that we have injected our AD credentials into memory, this is where the fun begins. With the 
/netonly option, all network communication will use these injected credentials for authentication. 
This includes all network communications of applications executed from that command prompt window.

This is where it becomes potent. Have you ever had a case where an MS SQL database used Windows 
Authentication, and you were not domain-joined? Start MS SQL Studio from that command prompt; even 
though it shows your local username, click Log In, and it will use the AD credentials in the 
background to authenticate! We can even use this to [authenticate to web applications that use NTLM 
Authentication](https://labs.f-secure.com/blog/pth-attacks-against-ntlm-authenticated-web-applications/).


### Enumeration through Microsoft Management Console

**Microsoft Management Console**

Installing Snap-Ins:

1. Press Start
2. Search "Apps & Features" and press enter
3. Click Manage Optional Features
4. Click Add a feature
5. Search for "RSAT"
6. Select "RSAT: Active Directory Domain Services and Lightweight Directory Tools" and click Install

You can start MMC by using the Windows Start button, searching run, and typing in MMC. If we just run 
MMC normally, it would not work as our computer is not domain-joined, and our local account cannot be 
used to authenticate to the domain.

This is where the Runas window comes into play. In that window, we can start MMC, which will ensure 
that all MMC network connections will use our injected AD credentials.

In MMC, we can now attach the AD RSAT Snap-In:

1. Click File -> Add/Remove Snap-in
2. Select and Add all three Active Directory Snap-ins
3. Click through any errors and warnings
4. Right-click on Active Directory Domains and Trusts and select Change Forest
5. Enter za.tryhackme.com as the Root domain and Click OK
6. Right-click on Active Directory Sites and Services and select Change Forest
7. Enter za.tryhackme.com as the Root domain and Click OK
8. Right-click on Active Directory Users and Computers and select Change Domain
9. Enter za.tryhackme.com as the Domain and Click OK
10. Right-click on Active Directory Users and Computers in the left-hand pane
11. Click on View -> Advanced Features

If everything up to this point worked correctly, your MMC should now be pointed to, and authenticated 
against, the target Domain


**Users and Computers**

Expanding the snap-in shows us the domains and expanding the domains shows the initial OU structure.
In the People directory we find the users divided into departments. Clicking on any of the users lets 
us review all of their properties and attributes as well as any groups they are part of.

MMC can also be used to find hosts in the environment, listing domain-joined Servers and Workstations.
If we had the relevant permissions, we could use MMC to directly make changes to AD.


**Benefits**

- The GUI provides an excellent method to gain a holistic view of the AD environment.

- Rapid searching of different AD objects can be performed.

- It provides a direct method to view specific updates of AD objects.

- If we have sufficient privileges, we can directly update existing AD objects or add new ones.


**Drawbacks**

- The GUI requires RDP access to the machine where it is executed.

- Although searching for an object is fast, gathering AD wide properties or attributes cannot be 
performed.


### Enumeration through Command Prompt

**Command Prompt**

CMD is handy when you perhaps don't have RDP access to a system, defenders are monitoring for 
PowerShell use, and you need to perform your AD Enumeration through a Remote Access Trojan (RAT). 

It can be helpful to embed a couple of simple AD enumeration commands in your phishing payload to help 
you gain the vital information that can help you stage the final attack.

CMD has a built-in command that we can use to gather information about AD called `net`. `net` 
is a handy tool to enumerate the local system and AD.

**Users**

List all users in an AD domain:

`net user /domain`

Detailed information about a specific user:

`net user <USERNAME> /domain`

Note: If the user is only part of a small number of AD groups, this command will be able to show us 
group memberships. However, usually, after more than ten group memberships, the command will fail to 
list them all.


**Groups**

List all Groups of an AD domain:

`net group /domain`

Detailed information about a specific group:

`net group "<GROUP-NAME>" /domain`


**Password Policy**

Enumerate the password polcy of an AD domain:

`net accounts /domain`

Providing us with:

- Length of password history kept. Meaning how many unique passwords must the user provide before they 
can reuse an old password.

- The lockout threshold for incorrect password attempts and for how long the account will be locked.

- The minimum length of the password.

- The maximum age that passwords are allowed to reach indicating if passwords have to be rotated at a 
regular interval.


**Benefits**

- No additional or external tooling is required, and these simple commands are often not monitored for 
by the Blue team.

- We do not need a GUI to do this enumeration.

- VBScript and other macro languages that are often used for phishing payloads support these commands 
natively so they can be used to enumerate initial information regarding the AD domain before more 
specific payloads are crafted.


**Drawbacks**

- The net commands must be executed from a domain-joined machine. If the machine is not domain-joined, 
it will default to the WORKGROUP domain.

- The net commands may not show all information. For example, if a user is a member of more than ten 
groups, not all of these groups will be shown in the output.


### Enumeration through PowerShell

**PowerShell**

PowerShell provides access to cmdlets, which are .NET classes that perform specific functions.

AD-RSAT automatically installs the associated cmdlets - [cmdlets reference](https://docs.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2022-ps)

[PowerView](https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerView) is a collection of custom cmdlets that is now well-known making it risky in monitored environments.

**Users**

Use `Get-ADUser` to enumerate AD Users

`Get-ADUser -Identity <USERNAME> -Server <FQDN> -Properties *`

- Identity - The account name that we are enumerating

- Properties - Which properties associated with the account will be shown, * will show all properties

- Server - Since we are not domain-joined, we use this parameter to point it to our domain controller

For most of these cmdlets, we can also use the `-Filter` parameter that allows more control over 
enumeration and use the `Format-Table` cmdlet to display the results such as the following neatly:

`Get-ADUser -Filter 'Name -like "*stevens"' -Server <FQDN> | Format-Table Name,SamAccountName -A`

**Groups**

Use `Get-ADGroup` to enumerate AD Groups

`Get-ADGroup -Identity <GROUP-NAME> -Server <FQDN> -Properties *` 

Use `Get-ADGroupMember` to enumerate members of an AD Group

`Get-ADGroupMember -Identity <GROUP-NAME> -Server <FQDN> `

**AD Objects**

Use `Get-ADObject` for a more generic search, for example all objects that were changed after a 
certain date:

```
$ChangeDate = New-Object DateTime(2022, 02, 28, 12, 00, 00)

Get-ADObject -Filter 'whenChanged -gt $ChangeDate' -includeDeletedObjects -Server za.tryhackme.com

```

All acounts with remaining bad password attempts to avoid lockouts when password spraying:

`Get-ADObject -Filter 'badPwdCount -gt 0' -Server <FQDN>`

This will only show results if one of the users in the network mistyped their password a couple of 
times

**Domains**

Use `Get-ADDomain` to retrieve additional information about a specific domain

`Get-ADDomain -Server za.tryhackme.com`

**Altering AD Objects**

Some AD-RSAT cmdlets allow you to create new or alter existing AD objects.

Force change a password

`Set-ADAccountPassword -Identity <USERNAME> -Server za.tryhackme.com -OldPassword (ConvertTo-SecureString -AsPlaintext "old" -force) -NewPassword (ConvertTo-SecureString -AsPlainText "new" -Force)` 

**Benefits**

- The PowerShell cmdlets can enumerate significantly more information than the net commands from 
Command Prompt.

- We can specify the server and domain to execute these commands using runas from a non-domain-joined 
machine.

- We can create our own cmdlets to enumerate specific information.

- We can use the AD-RSAT cmdlets to directly change AD objects, such as resetting passwords or adding 
a user to a specific group.

**Drawbacks**

- PowerShell is often monitored more by the blue teams than Command Prompt.

- We have to install the AD-RSAT tooling or use other, potentially detectable, scripts for PowerShell 
enumeration.


### Enumeration through Bloodhound

Two-stage attack:

1. Phishing campaign to gain foothold and exfiltrate AD enumeration data - Usually loud

2. Create an attack path in graph format. Second phishing campaign and exploitation using generated 
attack path

**Sharphound**

Sharphound is used to enumerate the AD domain.

Sharphound collectors:

- Sharphound.ps1 - PowerShell script for running Sharphound. Good to use with RATs as can be loaded 
into memory

- Sharphound.exe - Executable for Sharphound

- AzureHound.ps1 - PowerShell script for running Sharphound for Azure (Microsoft Cloud Computing 
Services) instances. Bloodhound can ingest data enumerated from Azure to find attack paths related to 
the configuration of Azure Identity and Access Management.

Note: Your Bloodhound and Sharphound versions must match for the best results. Usually there are 
updates made to Bloodhound which means old Sharphound results cannot be ingested.

When using these collector scripts on an assessment, there is a high likelihood that these files will 
be detected as malware and raise an alert to the blue team.

This is again where our Windows machine that is non-domain-joined can assist. We can use the `runas` 
command to inject the AD credentials and point Sharphound to a Domain Controller.

Since we control this Windows machine, we can either disable the AV or create exceptions for specific 
files or folders, which has already been performed for you on the THMJMP1 machine.

You can find the Sharphound binaries on this host in the C:\Tools\ directory. We will use the 
SharpHound.exe version for our enumeration, but feel free to play around with the other two.

`Sharphound.exe --CollectionMethods <METHODS> --Domain <FQDN> --ExcludeDCs`

- CollectionMethods - Determines what kind of data Sharphound would collect. The most common options 
are Default or All. Also, since Sharphound caches information, once the first run has been completed, 
you can only use the Session collection method to retrieve new user sessions to speed up the process.

- Domain - Here, we specify the domain we want to enumerate. In some instances, you may want to 
enumerate a parent or other domain that has trust with your existing domain. You can tell Sharphound 
which domain should be enumerated by altering this parameter.

- ExcludeDCs -This will instruct Sharphound not to touch domain controllers, which reduces the 
likelihood that the Sharphound run will raise an alert.

[Sharphound parameters](https://bloodhound.readthedocs.io/en/latest/data-collection/sharphound-all-flags.html)


