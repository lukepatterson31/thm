# Enumerating Active Directory

### Why AD Enumeration

**AD Enumeration**

Once we have that first set of AD credentials and the means to authenticate with them on the network, 
we can start enumerating various details about the AD setup and structure with authenticated access, 
even super low-privileged access.

During a red team engagement, this will usually lead to us being able to perform some form of 
privilege escalation or lateral movement to gain additional access until we have sufficient privileges 
to execute and reach our goals. 

In most cases, enumeration and exploitation are heavily entwined. Once an attack path shown by the 
enumeration phase has been exploited, enumeration is again performed from this new privileged position.

![Kill Chain](../pictures/kill-chain.png)


**Learning Objectives**

Enumeration techniques are usually highly situational and dependant on the acquired breach. We will 
cover the following techniques:

- The AD snap-ins of the Microsoft Management Console

- The net commands of Command Prompt

- The AD-RSAT cmdlets of PowerShell

- Bloodhound


### Credential Injection

**Runas Explained**

In security assessments, you will often have network access and have just discovered AD credentials 
but have no means or privileges to create a new domain-joined machine. So we need the ability to use 
those credentials on a Windows machine we control.

If we have the AD credentials in the format of :, we can use Runas, a legitimate Windows binary, to 
inject the credentials into memory. 

`runas.exe /netonly /user:<DOMAIN>\<USERNAME> cmd.exe`

- /netonly - Since we are not domain-joined, we want to load the credentials for network 
authentication but not authenticate against a domain controller. So commands executed locally on the 
computer will run in the context of your standard Windows account, but any network connections will 
occur using the account specified here.

- /user - Here, we provide the details of the domain and the username. It is always a safe bet to use 
the Fully Qualified Domain Name (FQDN) instead of just the NetBIOS name of the domain since this will 
help with resolution.

- cmd.exe - This is the program we want to execute once the credentials are injected. This can be 
changed to anything, but the safest bet is cmd.exe since you can then use that to launch whatever you 
want, with the credentials injected.

Once you run this command, you will be prompted to supply a password. Note that since we added the 
/netonly parameter, the credentials will not be verified directly by a domain controller so that it 
will accept any password. We still need to confirm that the network credentials are loaded 
successfully and correctly.


**It's Always DNS**

After providing the password, a new command prompt window will open. Now we still need to verify that 
our credentials are working. The most surefire way to do this is to list SYSVOL. Any AD account, no 
matter how low-privileged, can read the contents of the SYSVOL directory.

SYSVOL is a folder that exists on all domain controllers. It is a shared folder storing the Group 
Policy Objects (GPOs) and information along with any other domain related scripts. It is an essential 
component for Active Directory since it delivers these GPOs to all computers on the domain. 
Domain-joined computers can then read these GPOs and apply the applicable ones, making domain-wide 
configuration changes from a central location.

Before we can list SYSVOL, we need to configure our DNS. Sometimes you are lucky, and internal DNS 
will be configured for you automatically through DHCP or the VPN connection, but not always (like this 
TryHackMe network). It is good to understand how to do it manually. Your safest bet for a DNS server 
is usually a domain controller. Using the IP of the domain controller, we can execute the following 
commands in a PowerShell window:

```
$dnsip = "<DC IP>"
$index = Get-NetAdapter -Name '<ADAPTER-NAME>' | Select-Object -ExpandProperty 'ifIndex'
Set-DnsClientServerAddress -InterfaceIndex $index -ServerAddresses $dnsip
```

Then use dir to force a network-based listing of SYSVOL

`dir \\za.tryhackme.com\SYSVOL\`

It is good to enumerate SYSVOL as there may be additional AD credentials there.


**IP vs Hostnames**

Depending on whether the IP or hostname is used the authentication method changes. Hostnames will 
authenticate with kerberos and IP's with NTLM.

While on the surface, this does not matter to us right now, it is good to understand these slight 
differences since they can allow you to remain more stealthy during a Red team assessment. In some 
instances, organisations will be monitoring for OverPass- and Pass-The-Hash Attacks. Forcing NTLM 
authentication is a good trick to have in the book to avoid detection in these cases.

**Using Injected Credentials**

Now that we have injected our AD credentials into memory, this is where the fun begins. With the 
/netonly option, all network communication will use these injected credentials for authentication. 
This includes all network communications of applications executed from that command prompt window.

This is where it becomes potent. Have you ever had a case where an MS SQL database used Windows 
Authentication, and you were not domain-joined? Start MS SQL Studio from that command prompt; even 
though it shows your local username, click Log In, and it will use the AD credentials in the 
background to authenticate! We can even use this to [authenticate to web applications that use NTLM 
Authentication](https://labs.f-secure.com/blog/pth-attacks-against-ntlm-authenticated-web-applications/.


### Enumeration through Microsoft Management Console

**Microsoft Management Console**

Installing Snap-Ins:

1. Press Start
2. Search "Apps & Features" and press enter
3. Click Manage Optional Features
4. Click Add a feature
5. Search for "RSAT"
6. Select "RSAT: Active Directory Domain Services and Lightweight Directory Tools" and click Install

You can start MMC by using the Windows Start button, searching run, and typing in MMC. If we just run 
MMC normally, it would not work as our computer is not domain-joined, and our local account cannot be 
used to authenticate to the domain.

This is where the Runas window comes into play. In that window, we can start MMC, which will ensure 
that all MMC network connections will use our injected AD credentials.

In MMC, we can now attach the AD RSAT Snap-In:

1. Click File -> Add/Remove Snap-in
2. Select and Add all three Active Directory Snap-ins
3. Click through any errors and warnings
4. Right-click on Active Directory Domains and Trusts and select Change Forest
5. Enter za.tryhackme.com as the Root domain and Click OK
6. Right-click on Active Directory Sites and Services and select Change Forest
7. Enter za.tryhackme.com as the Root domain and Click OK
8. Right-click on Active Directory Users and Computers and select Change Domain
9. Enter za.tryhackme.com as the Domain and Click OK
10. Right-click on Active Directory Users and Computers in the left-hand pane
11. Click on View -> Advanced Features

If everything up to this point worked correctly, your MMC should now be pointed to, and authenticated 
against, the target Domain


**Users and Computers**

Expanding the snap-in shows us the domains and expanding the domains shows the initial OU structure.
In the People directory we find the users divided into departments. Clicking on any of the users lets 
us review all of their properties and attributes as well as any groups they are part of.

MMC can also be used to find hosts in the environment, listing domain-joined Servers and Workstations.
If we had the relevant permissions, we could use MMC to directly make changes to AD.

**Benefits**

- The GUI provides an excellent method to gain a holistic view of the AD environment.

- Rapid searching of different AD objects can be performed.

- It provides a direct method to view specific updates of AD objects.

- If we have sufficient privileges, we can directly update existing AD objects or add new ones.

**Drawbacks**

- The GUI requires RDP access to the machine where it is executed.

- Although searching for an object is fast, gathering AD wide properties or attributes cannot be 
performed.


### Enumeration through Command Prompt



