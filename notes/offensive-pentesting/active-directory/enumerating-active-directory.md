# Enumerating Active Directory

### Why AD Enumeration

**AD Enumeration**

Once we have that first set of AD credentials and the means to authenticate with them on the network, 
we can start enumerating various details about the AD setup and structure with authenticated access, 
even super low-privileged access.

During a red team engagement, this will usually lead to us being able to perform some form of privilege 
escalation or lateral movement to gain additional access until we have sufficient privileges to execute 
and reach our goals. 

In most cases, enumeration and exploitation are heavily entwined. Once an attack path shown by the 
enumeration phase has been exploited, enumeration is again performed from this new privileged position.

![Kill Chain](../pictures/kill-chain.png)


**Learning Objectives**

Enumeration techniques are usually highly situational and dependant on the acquired breach. We will 
cover the following techniques:

- The AD snap-ins of the Microsoft Management Console

- The net commands of Command Prompt

- The AD-RSAT cmdlets of PowerShell

- Bloodhound

Credentials for the exercise:

Username: charles.anderson
Password: Wafx2845


### Credential Injection

**Runas Explained**

In security assessments, you will often have network access and have just discovered AD credentials but 
have no means or privileges to create a new domain-joined machine. So we need the ability to use those 
credentials on a Windows machine we control.

If we have the AD credentials in the format of :, we can use Runas, a legitimate Windows binary, to 
inject the credentials into memory. 

`runas.exe /netonly /user:<DOMAIN>\<USERNAME> cmd.exe`

- /netonly - Since we are not domain-joined, we want to load the credentials for network authentication 
but not authenticate against a domain controller. So commands executed locally on the computer will run 
in the context of your standard Windows account, but any network connections will occur using the 
account specified here.

- /user - Here, we provide the details of the domain and the username. It is always a safe bet to use 
the Fully Qualified Domain Name (FQDN) instead of just the NetBIOS name of the domain since this will 
help with resolution.

- cmd.exe - This is the program we want to execute once the credentials are injected. This can be 
changed to anything, but the safest bet is cmd.exe since you can then use that to launch whatever you 
want, with the credentials injected.

Once you run this command, you will be prompted to supply a password. Note that since we added the 
/netonly parameter, the credentials will not be verified directly by a domain controller so that it 
will accept any password. We still need to confirm that the network credentials are loaded successfully 
and correctly.


**It's Always DNS**

After providing the password, a new command prompt window will open. Now we still need to verify that 
our credentials are working. The most surefire way to do this is to list SYSVOL. Any AD account, no 
matter how low-privileged, can read the contents of the SYSVOL directory.

SYSVOL is a folder that exists on all domain controllers. It is a shared folder storing the Group 
Policy Objects (GPOs) and information along with any other domain related scripts. It is an essential 
component for Active Directory since it delivers these GPOs to all computers on the domain. 
Domain-joined computers can then read these GPOs and apply the applicable ones, making domain-wide 
configuration changes from a central location.

Before we can list SYSVOL, we need to configure our DNS. Sometimes you are lucky, and internal DNS will 
be configured for you automatically through DHCP or the VPN connection, but not always (like this 
TryHackMe network). It is good to understand how to do it manually. Your safest bet for a DNS server is 
usually a domain controller. Using the IP of the domain controller, we can execute the following 
commands in a PowerShell window:

```
$dnsip = "<DC IP>"
$index = Get-NetAdapter -Name '<ADAPTER-NAME>' | Select-Object -ExpandProperty 'ifIndex'
Set-DnsClientServerAddress -InterfaceIndex $index -ServerAddresses $dnsip
```

Then use dir to force a network-based listing of SYSVOL

`dir \\za.tryhackme.com\SYSVOL\`

It is good to enumerate SYSVOL as there may be additional AD credentials there.


**IP vs Hostnames**

