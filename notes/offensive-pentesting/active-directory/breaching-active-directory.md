# Breaching Active Directory

Set up:

Change DNS in Advanced Network Configuration to THMDC IP

### OSINT and Phishing

OSINT

- Users who ask questions on public forums such as Stack Overflow but disclose sensitive 
information such as their credentials in the question.

- Developers that upload scripts to services such as Github with credentials hardcoded.

- Credentials being disclosed in past breaches since employees used their work accounts to 
sign up for other external websites. Websites such as HaveIBeenPwned and DeHashed provide 
excellent platforms to determine if someone's information, such as work email, was ever 
involved in a publicly known data breach.

Red Team OSINT room [here](https://tryhackme.com/jr/redteamrecon).

Phishing

Phishing is another excellent method to breach AD. Phishing usually entices users to either 
provide their credentials on a malicious web page or ask them to run a specific application 
that would install a Remote Access Trojan (RAT) in the background. 

This is a prevalent method since the RAT would execute in the user's context, immediately 
allowing you to impersonate that user's AD account.

Phishing room [here](https://tryhackme.com/module/phishing).


### NTLM Authenticated Services

**NTLM and NetNTLM**

New Technology LAN Manager (NTLM) is the suite of security protocols used to authenticate 
users' identities in AD. NTLM can be used for authentication by using a _challenge-response 
based scheme called NetNTLM_.

This authentication mechanism is heavily used by the services on a network. However, 
services that use NetNTLM can also be exposed to the internet.

- Internally-hosted Exchange (Mail) servers that expose an Outlook Web App (OWA) login 
portal.

- Remote Desktop Protocol (RDP) service of a server being exposed to the internet.

- Exposed VPN endpoints that were integrated with AD.

- Web applications that are internet-facing and make use of NetNTLM.

NetNTLM, also often referred to as Windows Authentication or just NTLM Authentication, 
allows the application to play the role of a middle man between the client and AD. 

All authentication material is forwarded to a Domain Controller in the form of a challenge, 
and if completed successfully, the application will authenticate the user.

This means that the application is authenticating on behalf of the user and not 
authenticating the user directly on the application itself. 

This prevents the application from storing AD credentials, which should only be stored on a 
Domain Controller.

![Authentication process](../pictures/netntlm.png)


**Brute-force Login Attacks**

Most Active Directory environments have account lockout policies so password spraying is a noisy but 
viable alternative.

Use [ntlm_passwordspray.py](./ntlm_passwordspray.py) to attempt a password spraying attack against the 
NetNTLM authentication service

**Password Spraying**

Password spraying uses lots of usernames and one password to find credential pairs.

`./ntlm_passwordspray.py -u users.txt -f <FULLY-QUALIFIED-DOMAIN-NAME> -p password -a <TARGET-URL>`


### LDAP Bind Credentials

**LDAP**

Default port 389

Lightweight Directory Access Protocol (LDAP) authentication is similar to NTLM authentication except
the application verfies the user's credentials.

LDAP is a popular mechanism for non-Microsoft applications that integrate with AD, such as:

- Gitlab

- Jenkins

- Custom-developed web applications

- Printers

- VPNs

As LDAP authentication requires a set of AD credentials, it opens up additional attack avenues. In 
essence, we can attempt to recover the AD credentials used by the service to gain authenticated 
access to AD.

![LDAP auth](../pictures/ldap-auth.png)

Credentials are usually stored in plaintext configuration files since the security model relies on 
keeping the location and storage configuration file secure rather than its contents.


**LDAP Pass-back Attacks**

Pass-back attacks are a common attack against network devices, such as printers, when you have gained 
initial access to the internal network, such as plugging in a rogue device in a boardroom.

LDAP Pass-back attacks can be performed when we gain access to a device's configuration where the 
LDAP parameters are specified. This can be, for example, the web interface of a network printer. 

Usually, the credentials for these interfaces are kept to the default ones, such as `admin:admin` or 
`admin:password`. 

Here, we won't be able to directly extract the LDAP credentials since the password is usually hidden. 
However, we can alter the LDAP configuration, such as the IP or hostname of the LDAP server. 

In an LDAP Pass-back attack, we can modify this IP to our IP and then test the LDAP configuration, 
which will force the device to attempt LDAP authentication to our rogue device. 

We can intercept this authentication attempt to recover the LDAP credentials.


**Performing an LDAP Pass-back**

Start netcat on port 389, LDAP default. Then navigate to the printer settings and replace the Server 
IP with the attacking machine's IP and press test the settings.

The supportedCapabilities response tells us we have a problem. Essentially, before the printer sends 
over the credentials, it is trying to negotiate the LDAP authentication method details. 

It will use this negotiation to select the most secure authentication method that both the printer 
and the LDAP server support. 

If the authentication method is too secure, the credentials will not be transmitted in cleartext. 
With some authentication methods, the credentials will not be transmitted over the network at all.

We will need to create a rogue LDAP server and configure it insecurely.


**Hosting a Rogue LDAP Server**

Install OpenLDAP

`sudo apt-get update && sudo apt-get -y install slapd ldap-utils && sudo systemctl enable slapd`

Press <No> when requested if you want to skip server configuration

For the DNS domain name, you want to provide our target domain, which is za.tryhackme.com

Use this same name for the Organisation name as well

Provide any Administrator password

Select MDB as the LDAP database to use

For the last two options, ensure the database is not removed when purged

Move old database files before a new one is created

Before using the rogue LDAP server, we need to make it vulnerable by downgrading the supported 
authentication mechanisms. We want to ensure that our LDAP server only supports PLAIN and LOGIN 
authentication methods. To do this, we need to create a new ldif file, called with the following 
content:

olcSaslSecProps.ldif
```        
#olcSaslSecProps.ldif
dn: cn=config
replace: olcSaslSecProps
olcSaslSecProps: noanonymous,minssf=0,passcred
```

The file has the following properties:


- olcSaslSecProps: Specifies the SASL security properties

- noanonymous: Disables mechanisms that support anonymous login

- minssf: Specifies the minimum acceptable security strength with 0, meaning no protection.

Now we can use the ldif file to patch our LDAP server using the following:

sudo ldapmodify -Y EXTERNAL -H ldapi:// -f ./olcSaslSecProps.ldif && sudo service slapd restart

We can verify that our rogue LDAP server's configuration has been applied using the following command:
LDAP search to verify supported authentication mechanisms

```       
[thm@thm]$ ldapsearch -H ldap:// -x -LLL -s base -b "" supportedSASLMechanisms
dn:
supportedSASLMechanisms: PLAIN
supportedSASLMechanisms: LOGIN
```


**Capturing LDAP Credentials**

Test the connection again and dump the packet data with tcpdump to see the password in cleartext:

`sudo tcpdump -SX -i breachad tcp port 389`

-S Print absolute, rather than relative, TCP sequence numbers
-X print the data of each packet (minus its link level header) in hex and ASCII


### Authentication Relays

**Server Message Block**

Two exploits for NetNTLM authentication with SMB:

- Since the NTLM Challenges can be intercepted, we can use offline cracking techniques to recover the 
password associated with the NTLM Challenge. However, this cracking process is significantly slower 
than cracking NTLM hashes directly.

- We can use our rogue device to stage a man in the middle attack, relaying the SMB authentication 
between the client and server, which will provide us with an active authenticated session and access 
to the target server. 


**LLMNR, NBT-NS, and WPAD**

Link-Local Multicast Name Resolution (LLMNR), NetBIOS Name Service (NBT-NS, predecessor of LLMNR),
and Web Proxy Auto-Discovery (WPAD)

Use Responder to listen to and poison any LLMNR, NBT-NS and WPAD requests. On large Windows networks, 
these protocols allow hosts to perform their own local DNS resolution for all hosts on the same local 
network.

Rather than overburdening network resources such as the DNS servers, hosts can first attempt 
to determine if the host they are looking for is on the same local network by sending out LLMNR 
requests and seeing if any hosts respond.

The NBT-NS is the precursor protocol to LLMNR, and WPAD requests are made to try and find a proxy for 
future HTTP(s) connections. 


**Relaying the Challenge**

In some instances, however, we can take this a step further by trying to relay the challenge instead 
of just capturing it directly. This is a little bit more difficult to do without prior knowledge of 
the accounts since this attack depends on the permissions of the associated account. We need a couple 
of things to play in our favour:

- SMB Signing should either be disabled or enabled but not enforced. When we perform a relay, we make 
minor changes to the request to pass it along. If SMB signing is enabled, we won't be able to forge 
the message signature, meaning the server would reject it.

- The associated account needs the relevant permissions on the server to access the requested 
resources. Ideally, we are looking to relay the challenge and response of an account with 
administrative privileges over the server, as this would allow us to gain a foothold on the host.

- Since we technically don't yet have an AD foothold, some guesswork is involved into what accounts 
will have permissions on which hosts. If we had already breached AD, we could perform some initial 
enumeration first, which is usually the case.

This is why blind relays are not usually popular. Ideally, you would first breach AD using another 
method and then perform enumeration to determine the privileges associated with the account you have 
compromised. 

From here, you can usually perform lateral movement for privilege escalation across the domain. 

![Relay attack](../pictures/ntlm-relay.png)


### Microsoft Deployment Toolkit

**MDT and SCCM**

Microsoft Development Toolkit (MDT) assists automating deployments of Microsoft operating systems.
Usually MDT is integrated with Microsoft's System Center Configuration Manager (SCCM), which manages 
all updates for all Microsoft applications, services, and operating systems. 

MDT is used for new deployments allowing IT teasms to preconfigure and manage boot images. 
If they need to configure a new machine, they just need to plug in a network cable, and everything 
happens automatically.

SCCM can be seen as almost an expansion and the big brother to MDT. SCCM does a type of patch 
management allowing the IT team to review available updates to all software installed across the 
estate. The team can also test these patches in a sandbox environment to ensure they are stable 
before centrally deploying them to all domain-joined machines.

However, anything that provides central management of infrastructure such as MDT and SCCM can also be
targeted by attackers in an attempt to take over large portions of critical functions in the estate.


**PXE Boot**

Large organisations use PXE boot to allow new devices that are connected to the network to load and 
install the OS directly over a network connection. MDT can be used to create, manage, and host PXE 
boot images. 

PXE boot is usually integrated with DHCP, which means that if DHCP assigns an IP lease, the host is 
allowed to request the PXE boot image and start the network OS installation process.

![Communication flow](../pictures/pxe-boot.png)

Once the process is performed, the client will use a TFTP connection to download the PXE boot image. 
We can exploit the PXE boot image for two different purposes:

- Inject a privilege escalation vector, such as a Local Administrator account, to gain Administrative 
access to the OS once the PXE boot has been completed.

- Perform password scraping attacks to recover AD credentials used during the install.


**PXE Boot Image Retrieval**

Steps for password scraping attack to recover AD credentials:

1. Request IP and the PXE Boot preconfigure details from DHCP.

2. Discover MDT server IP and the names of the BCD files

3. Use TFTP to request the contents of the BCD files with TFTP
`tftp -i <TARGET-IP> GET "\path\to\bcd\file" conf.bcd`

4. Enumerate the BCD files with [powerpxe](https://github.com/wavestone-cdt/powerpxe) and extract the 
path to the wim file.
```
powershell -executionpolicy bypass
Import-Module .\PowerPXE.ps1
$BCDFile = "conf.bcd"
Get-WimFile -bcdFile $BCDFile
```

5. Get the WIM file and extract the credentials

```
tftp -i <TARGET-IP> GET "\path\to\wim\file" pxeboot.wim
Get-FindCredentials -WimFile pxeboot.wim
```


### Configuration Files

If you gain access to a host on the organization's network, configuration files can be a good source
of AD credentials.

- Web app config files

- Service configuration files

- Registry keys

- Centrally deployed applications

Enumeration can be automated with scripts like [Seatbelt](https://github.com/GhostPack/Seatbelt)


**Configuration Files Credentials**

Steps for recovering credentials from a centrally deployed application, using McAfee Enterprise 
Endpoint Security as an example.

McAfee embeds the credentials used during installation to connect back orchestrator in a file called 
ma.db. This database file can be retrieved and read with local access to the host to recover the 
associated AD service account.

The ma.db location is fixed, `C:\ProgramData\McAfee\Agent\DB`, copy the file to the attacking machine 
and open it with `sqlitebrowser ma.db`.

Look for the AGENT_REPOSITORY table and the DOMAIN, AUTH_USER, and AUTH_PASSWD field entries.

The AUTH_PASSWD can be decrypted using this [python2 script](./mcafee-sitelist-pwd-decryption-master/mcafee_sitelist_pwd_decrypt.py)


### Conclusion

A significant amount of attack avenues can be followed to breach AD. Building a proper enumeration 
methodology and continuously updating it will be required to find that initial pair of credentials.

Mitigations

In terms of mitigations, there are some steps that organisations can take:

- User awareness and training - The weakest link in the cybersecurity chain is almost always users. 
Training users and making them aware that they should be careful about disclosing sensitive 
information such as credentials and not trust suspicious emails reduces this attack surface.

- Limit the exposure of AD services and applications online - Not all applications must be accessible 
from the internet, especially those that support NTLM and LDAP authentication. Instead, these 
applications should be placed in an intranet that can be accessed through a VPN. The VPN can then 
support multi-factor authentication for added security.

- Enforce Network Access Control (NAC) - NAC can prevent attackers from connecting rogue devices on 
the network. However, it will require quite a bit of effort since legitimate devices will have to be 
allowlisted.

- Enforce SMB Signing - By enforcing SMB signing, SMB relay attacks are not possible.

- Follow the principle of least privileges - In most cases, an attacker will be able to recover a set 
of AD credentials. By following the principle of least privilege, especially for credentials used for 
services, the risk associated with these credentials being compromised can be significantly reduced.

