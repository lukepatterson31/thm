# Persisting Active Directory

### Persisitence Through Credentials

DA account: Administrator:tryhackmewouldnotguess1@:ZA

**DC Sync**

It is not sufficient to have a single domain controller per domain in large organisations. These domains are 
often used in multiple regional locations, and having a single DC would significantly delay any 
authentication services in AD. As such, these organisations make use of multiple DCs. The question then 
becomes, how is it possible for you to authenticate using the same credentials in two different offices?

The answer to that question is domain replication. Each domain controller runs a process called the Knowledge 
Consistency Checker (KCC). The KCC generates a replication topology for the AD forest and automatically 
connects to other domain controllers through Remote Procedure Calls (RPC) to synchronise information. This 
includes updated information such as the user's new password and new objects such as when a new user is 
created. This is why you usually have to wait a couple of minutes before you authenticate after you have 
changed your password since the DC where the password change occurred could perhaps not be the same one as 
the one where you are authenticating to.

The process of replication is called DC Synchronisation. It is not just the DCs that can initiate 
replication. Accounts such as those belonging to the Domain Admins groups can also do it for legitimate 
purposes such as creating a new domain controller.

A popular attack to perform is a DC Sync attack. If we have access to an account that has domain replication 
permissions, we can stage a DC Sync attack to harvest credentials from a DC.

**Not All Credentials Are Created Equal**

Before starting our DC Sync attack, let's first discuss what credentials we could potentially hunt for. While 
we should always look to dump privileged credentials such as those that are members of the Domain Admins 
group, these are also the credentials that will be rotated (a blue team term meaning to reset the account's 
password) first. As such, if we only have privileged credentials, it is safe to say as soon as the blue team 
discovers us, they will rotate those accounts, and we can potentially lose our access.

The goal then is to persist with near-privileged credentials. We don't always need the full keys to the 
kingdom; we just need enough keys to ensure we can still achieve goal execution and always make the blue team 
look over their shoulder. As such, we should attempt to persist through credentials such as the following:

- Credentials that have local administrator rights on several machines. Usually, organisations have a group 
or two with local admin rights on almost all computers. These groups are typically divided into one for 
workstations and one for servers. By harvesting the credentials of members of these groups, we would still 
have access to most of the computers in the estate.

- Service accounts that have delegation permissions. With these accounts, we would be able to force golden 
and silver tickets to perform Kerberos delegation attacks.

- Accounts used for privileged AD services. If we compromise accounts of privileged services such as 
Exchange, Windows Server Update Services (WSUS), or System Center Configuration Manager (SCCM), we could 
leverage AD exploitation to once again gain a privileged foothold.

When it comes to what credentials to dump and persist through, it is subject to many things. You will have to 
get creative in your thinking and take it on a case-by-case basis. 

**DC Sync All**

As a DA ssh into a jump server (THMWRK1) and start mimikatz

To perform a DC Sync of a single account:

`mimikatz # lsadump::dcsync /domain:za.tryhackme.loc /user:username`

To DC Sync every account, first enable logging:

```
mimikatz # log /path/to/log/file.txt
Using '/path/to/log/file.txt' for logfile: OK
```

Then run the above command, replacing `/user:` with `/all`

`mimikatz # lsadump::dcsync /domain:za.tryhackme.loc /all`

Once done, exit Mimikatz to finalise the dump find and then you can download the file. You can use 
`cat file.txt | grep "SAM Username"` to recover all the usernames and `cat file.txt | grep "Hash NTLM"` for 
all hashes. We can now either perform an offline password cracking attack to recover the plain text 
credentials or simply perform a pass the hash attack with Mimikatz.

**Persistence through Tickets**

