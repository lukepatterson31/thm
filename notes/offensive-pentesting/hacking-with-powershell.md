# Hacking with PowerShell

**Objectives**

- What is PowerShell
- Basic PowerShell commands
- Windows enumeration scripts
- PowerShell scripting

### What is PowerShell?

Powershell is the Windows Scripting Language and shell environment built using the .NET framework.

This also allows Powershell to execute .NET functions directly from its shell. Most Powershell commands, 
called cmdlets, are written in .NET. Unlike other scripting languages and shell environments, the output of 
these cmdlets are objects - making Powershell somewhat object-oriented.

This also means that running cmdlets allows you to perform actions on the output object (which makes it 
convenient to pass output from one cmdlet to another). The normal format of a cmdlet is represented using 
Verb-Noun; for example, the cmdlet to list commands is called Get-Command

Common verbs to use include:

- Get
- Start
- Stop 
- Read
- Write
- New
- Out

Complete list of [approved verbs here](https://docs.microsoft.com/en-us/powershell/scripting/developer/cmdlet/approved-verbs-for-windows-powershell-commands?view=powershell-7).

### Basic PowerShell Commands

**Using Get-Help**

`Get-Help` displays information about a cmdlet. To get help with a particular command, run the following:

`Get-Help Command-Name`

You can also understand how exactly to use the command by passing in the `-examples` flag.

`Get-Help Get-Command -Examples`

**Using Get-Command**

`Get-Command` gets all the cmdlets installed on the current Computer. The great thing about this cmdlet is 
that it allows for pattern matching like the following

`Get-Command Verb-*` or `Get-Command *-Noun`

`Get-Command New-*` will show all commands starting with New-

**Object Manipulation**

In the previous task, we saw how the output of every cmdlet is an object. If we want to manipulate the 
output, we need to figure out a few things:

- passing the output to other cmdlets
- using specific object cmdlets to extract information

The Pipeline(`|`) is used to pass output from one cmdlet to another. A major difference compared to other 
shells is that Powershell passes an object to the next cmdlet instead of passing text or string to the 
command after the pipe. Like every object in object-oriented frameworks, an object will contain methods and 
properties.

You can think of methods as functions that can be applied to output from the cmdlet, and you can think of 
properties as variables in the output from a cmdlet. To view these details, pass the output of a cmdlet to 
the `Get-Member` cmdlet:

`Verb-Noun | Get-Member `

An example of running this to view the members or properties for `Get-Command` is:

`Get-Command | Get-Member -MemberType Method`

`Get-Command | Get-Member -MemberType Properties`

**Creating Objects from Previous cmdlets**

One way of manipulating objects is pulling out the properties from the output of a cmdlet and creating a new 
object. This is done using the `Select-Object` cmdlet. 

Here's an example of listing the directories and just selecting the mode and the name:

`Get-ChildItem | Select-Object -Property Mode,Name`

You can also use the following flags to select particular information:

- first - gets the first x object
- last - gets the last x object
- unique - shows the unique objects
- skip - skips x objects

**Filtering Objects**

When retrieving output objects, you may want to select objects that match a very specific value. You can do 
this using the `Where-Object` to filter based on the value of properties. 

The general format for using this cmdlet is:

`Verb-Noun | Where-Object -Property PropertyName -operator Value`

`Verb-Noun | Where-Object {$_.PropertyName -operator Value}`

The second version uses the `$_` operator to iterate through every object passed to the `Where-Object`
cmdlet.

*Note: Powershell is quite sensitive, so don't put quotes around the command!*

Where `-operator` is a list of the following operators:

- `-Contains`: if any item in the property value is an exact match for the specified value
- `-EQ`: if the property value is the same as the specified value
- `-GT`: if the property value is greater than the specified value

Full list of [operators here](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/where-object?view=powershell-6).

Here's an example of checking the stopped processes:

`Get-Service | Where-Object -Property Status -eq Stopped`

**Sort-Object**

When a cmdlet outputs a lot of information, you may need to sort it to extract the information more 
efficiently. You do this by pipe-lining the output of a cmdlet to the `Sort-Object` cmdlet.

The format of the command would be:

`Verb-Noun | Sort-Object`

Here's an example of sorting the list of directories:

`Get-ChildItem | Sort-Object`

**Questions**

What is the location of the file "interesting-file.txt"

`Get-ChildItem -Path C:\ -Recurse -ErrorAction SilentlyContinue -Include interesting-file`

Specify the contents of this file

`Write-Output /path/to/file`

How many cmdlets are installed on the system(only cmdlets, not functions and aliases)?

`Get-Command | Where-Object -Property CommandType -eq cmdlet | Measure-Object`

Get the MD5 hash of interesting-file.txt

`Get-FileHash -Algorithm MD5 /path/to/file`

What is the command to get the current working directory?

`Get-Location`

Does the path "C:\Users\Administrator\Documents\Passwords" Exist (Y/N)?

`Get-ChildItem C:\Users\Administrator\Desktop`

What command would you use to make a request to a web server?

`Invoke-WebRequest`

Base64 decode the file b64.txt on Windows. 

```
Get-ChildItem -Path C:\ -Recurse -ErrorAction SilentlyContinue -Include *b64.txt*

[Text.Encoding]::Utf8.GetString([Convert]::FromBase64String($(type C:\Users\Administrator\Desktop\b64.txt)))

```

### Enumeration

How many users are there on the machine?

`Get-LocalUser | Measure-Object`

Which local user does this SID(S-1-5-21-1394777289-3961777894-1791813945-501) belong to?

`Get-localUser -SID S-1-5-21-1394777289-3961777894-1791813945-501`

How many users have their password required values set to False?

`Get-LocalUser | Where-Object -Property PasswordRequired -like false`

How many local groups exist?

`Get-LocalGroup | Measure-Object`

What command did you use to get the IP address info?

`Get-NetIPAddress`

How many ports are listed as listening?

`Get-NetTCPConnection | Where-Object -Property State -like listen | Measure-Object`

How many patches have been applied?

`Get-HotFix | Measure-Object`

When was the patch with ID KB4023834 installed?

`Get-HotFix | Where-Object -Property HotFixID -like KB4023834 | Select-Object -Property InstalledOn | Write-Output`

Find the contents of a backup file.

```
Get-ChildItem -Path C:\ -Recurse -ErrorAction SilentlyContinue -Include *.bak*

Get-Content /path/to/bak
```
Search for all files containing API_KEY

`Get-ChildItem -Path C:\ -Recurse -ErrorAction SilentlyContinue -Include *API_KEY*`

What command do you do to list all the running processes?

`Get-Process`

What is the path of the scheduled task called new-sched-task?

`Get-ScheduledTask -TaskName new-sched-task`

Who is the owner of C:\\?

`Get-Acl C:\`

### Basic Scripting Challenge


```
// listening-ports.ps1

$system_ports = Get-NetTCPConnection -State Listen

$text_port = Get-Content -Path C:\Users\Administrator\Desktop\ports.txt

foreach($port in $text_port){

    if($port -in $system_ports.LocalPort){
        echo $port
     }

}

```

```
// email-parser.ps1

$path = Get-ChildItem -Path C:\Users\Administrator\Desktop\emails


foreach($dir in $path){
    Get-ChildItem -Path $dir.FullName | Select-string -Pattern password
    Get-ChildItem -Path $dir.FullName | Select-string -Pattern https://
    }

```

### Intermediate Scripting

Write a port scanner, general approach to use: 

- Determine IP ranges to scan (in this case it will be localhost) and you can provide the input in any way 
you want
- Determine the port ranges to scan
- Determine the type of scan to run(in this case it will be a simple TCP Connect Scan)

The question accepts 11 as the answer when only port 135 is shown as open

```
// Using Test-NetConnection
$target = $args[0]
$ports = $args[1]

foreach($port in $ports){
    Test-NetConnection $target -port $port
}
```


[SANS PowerShell port scanner article](https://www.sans.org/blog/pen-test-poster-white-board-powershell-built-in-port-scanner/)
```
// SANS article one-liner
1..1024 | % {echo ((new-object Net.Sockets.TcpClient).Connect("10.0.0.100",$_)) "Port $_ is open!"} 2>$null
```

### Notes

`foreach($i in $list){ $i } => % { $_ }`

```
Get-ChildItem | % { Select-String -Path $_.FullName -Pattern password }

is equivalent to:

$directories = Get-ChildItem 

foreach($dir in $directories){
    Select-String -Path $dir.FullName -Pattern password
}
```
